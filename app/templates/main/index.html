{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block styles %}
<style>
    /* Sticky Header with Glass-morphism */
    .feed-header {
        position: sticky;
        top: 0;
        background-color: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        z-index: 1000;
        border-bottom: 1px solid #2f3336;
    }

    /* Composer Section (Desktop) */
    .composer-section {
        border-bottom: 1px solid #2f3336;
        padding: 1.25rem 1rem;
    }
    .composer-input-field {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.25rem;
        resize: none;
        width: 100%;
        min-height: 50px;
        font-family: inherit;
    }
    .composer-input-field:focus { outline: none; box-shadow: none; }

    /* Post Card Styling (Edge-to-Edge) */
    .post-card {
        border-bottom: 1px solid #2f3336;
        padding: 1rem;
        transition: background-color 0.2s;
        text-decoration: none;
        display: block;
        color: inherit;
        position: relative;
    }
    .post-card:hover { background-color: rgba(255, 255, 255, 0.03); }

    /* Identity Logic Styling */
    .display-name { font-weight: 700; color: white; line-height: 1.2; }
    .handle { color: #6c757d; font-size: 0.95rem; }

    /* Minimal Modal UI */
    .modal-minimal {
        max-width: 500px;
        margin: 1.75rem auto;
    }
    @media (max-width: 576px) {
        .modal-minimal {
            margin: 1rem;
            max-width: calc(100% - 2rem);
        }
    }
    .modal-content {
        background-color: #000;
        border: 1px solid #2f3336;
        border-radius: 20px;
    }

    /* Interaction Icons */
    .action-btn {
        color: #71767b;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        border: none;
        background: transparent;
        padding: 8px 12px;
        border-radius: 50px;
        position: relative;
        z-index: 5;
    }
    .action-btn:hover.reply { color: #1d9bf0; background: rgba(29, 155, 240, 0.1); }
    .action-btn:hover.like { color: #f91880; background: rgba(249, 24, 128, 0.1); }

    .post-fab {
        position: fixed;
        bottom: 85px;
        right: 20px;
        width: 56px;
        height: 56px;
        z-index: 1040;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="feed-header p-3">
    <h5 class="fw-bold mb-0">Home</h5>
</div>

{% if current_user.is_authenticated %}
<div class="composer-section d-none d-sm-block">
    <div class="d-flex gap-3">
        <img src="{{ current_user.profile_pic_url or 'https://ui-avatars.com/api/?name=' + current_user.username }}" class="rounded-circle" width="48" height="48">
        <div class="flex-grow-1">
            <form action="{{ url_for('main.add_note') }}" method="POST">
                {{ form.hidden_tag() }}
                {{ form.content(class="composer-input-field", placeholder="What's happening?", rows="2") }}
                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-secondary-subtle">
                    <div class="text-primary fs-5"><i class="bi bi-image"></i></div>
                    <button type="submit" class="btn btn-primary rounded-pill fw-bold px-4">Post</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<div class="notes-feed">
    {% if notes %}
        {% for note in notes %}
        <div class="post-card">
            <a href="{{ url_for('main.view_note', id=note.id) }}" class="stretched-link"></a>
            
            <div class="d-flex gap-3">
                <img src="{{ note.user.profile_pic_url or 'https://ui-avatars.com/api/?name=' + note.user.username }}" 
                     class="rounded-circle" width="48" height="48" style="object-fit: cover; position: relative; z-index: 5;">
                
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="position: relative; z-index: 5;">
                            {% if note.user.name %}
                                <div class="display-name">{{ note.user.name }}</div>
                                <div class="handle">@{{ note.user.username }} · {{ note.created_at.strftime('%b %d') }}</div>
                            {% else %}
                                <div class="display-name">@{{ note.user.username }} <span class="handle fw-normal">· {{ note.created_at.strftime('%b %d') }}</span></div>
                            {% endif %}
                        </div>

                        {% if current_user.is_authenticated and current_user.id == note.user_id %}
                        <div class="dropdown" style="position: relative; z-index: 6;">
                            <button class="btn btn-link text-secondary p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow border-secondary rounded-3">
                                <li><a class="dropdown-item" href="{{ url_for('main.edit_note', id=note.id) }}"><i class="bi bi-pencil me-2"></i> Edit</a></li>
                                <li><button class="dropdown-item text-danger fw-bold" data-bs-toggle="modal" data-bs-target="#deleteModal{{ note.id }}"><i class="bi bi-trash3 me-2"></i> Delete</button></li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div style="position: relative; z-index: 5;">
                        <p class="text-white mt-2 mb-2" style="white-space: pre-wrap;">{{ note.content }}</p>
                        
                        <div class="d-flex justify-content-between mt-3 text-secondary pe-5" style="max-width: 400px;">
                            <button class="action-btn reply"><i class="bi bi-chat"></i> 0</button>
                            <button class="action-btn like"><i class="bi bi-heart"></i> 0</button>
                            <button class="action-btn"><i class="bi bi-share"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if current_user.is_authenticated and current_user.id == note.user_id %}
        <div class="modal fade" id="deleteModal{{ note.id }}" tabindex="-1">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content p-3 border-secondary shadow-lg">
                    <div class="modal-body text-center">
                        <h5 class="fw-bold text-white mb-2">Delete Note?</h5>
                        <p class="text-secondary small">This can’t be undone and it will be removed from your profile and timeline.</p>
                        <form action="{{ url_for('main.delete_note', id=note.id) }}" method="POST">
                            <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold mb-2">Delete</button>
                            <button type="button" class="btn btn-outline-light w-100 rounded-pill fw-bold" data-bs-dismiss="modal">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <p class="text-secondary">No notes found. Be the first to share something!</p>
        </div>
    {% endif %}
</div>

{% if current_user.is_authenticated %}
<button class="btn btn-primary rounded-circle d-sm-none post-fab" data-bs-toggle="modal" data-bs-target="#composeModal">
    <i class="bi bi-plus-lg fs-3"></i>
</button>

<div class="modal fade" id="composeModal" tabindex="-1">
    <div class="modal-dialog modal-minimal modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                <button type="submit" form="modalPostForm" class="btn btn-primary rounded-pill fw-bold px-4 ms-auto">Post</button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-3">
                    <img src="{{ current_user.profile_pic_url or 'https://ui-avatars.com/api/?name=' + current_user.username }}" class="rounded-circle" width="40" height="40">
                    <form id="modalPostForm" action="{{ url_for('main.add_note') }}" method="POST" class="w-100">
                        {{ form.hidden_tag() }}
                        {{ form.content(class="composer-input-field", placeholder="What's on your mind?", rows="5", autofocus=true) }}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Ensure autofocus works when modal is triggered
    var composeModal = document.getElementById('composeModal');
    if (composeModal) {
        composeModal.addEventListener('shown.bs.modal', function () {
            this.querySelector('textarea').focus();
        });
    }
</script>
{% endblock %}